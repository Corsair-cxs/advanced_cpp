# Optimizing C++ Compile Time
åŸæ–‡é“¾æ¥: https://ssarcandy.tw/2022/06/11/optimizing-compile-time/
ç¼–è¯‘æ˜¯é™æ€è¯­è¨€ä¸å¯é¿å…çš„æ­¥éª¤ã€‚ å¯¹äºå¼€å‘è€…è€Œè¨€ï¼Œç¼–è¯‘æ˜¯ä¸ªåˆçˆ±åˆæ¨çš„ä¸œè¥¿ï¼Œå¥½å¤„æ˜¯ä»–å¯ä»¥å¸®åŠ©åœ¨ç¼–è¯‘æ—¶æœŸæ‰¾å‡ºéƒ¨åˆ†çš„é”™è¯¯åˆå¯ä»¥å¸®å¿™æœ€ä½³åŒ–ï¼Œä½†æ˜¯åå¤„åˆ™æ˜¯ç¼–è¯‘è¦æ—¶é—´ï¼Œå½“é¡¹ç›®è¶Šæ¥è¶Šå¤§æ—¶ï¼Œå°å°æ”¹ä¸ªæ¡£æ¡ˆå¯èƒ½å°±è¦èŠ±æ•°åˆ†é’Ÿå»ç­‰ç¼–è¯‘ã€‚

![image-20221227221102038](./img/Optimizing%20C++%20Compile%20Time/image-20221227221102038.png)


éšç€ C++ çš„å‘å±•ï¼Œç°åœ¨ modern C++ å¦‚ C++14ï¼Œ 17 ç­‰ç­‰ï¼Œæ–°å¢äº†æ›´å¤šæ–¹å¼è®©å¼€å‘è€…åœ¨ç¼–è¯‘æ—¶æœŸå®Œæˆæ›´å¤šäº‹æƒ…ï¼Œæ¯”å¦‚è¯´æ›´æ–¹ä¾¿çš„ç­‰ç­‰åŠŸèƒ½ã€‚ è€Œè¿™å…¶å®ä¹Ÿæ˜¯è¢«é¼“åŠ±çš„ï¼Œå› ä¸ºèƒ½åœ¨ç¼–è¯‘æ—¶æœŸå°±å¤„ç†å®Œçš„è¯å°±å¯ä»¥è®© runtime æ‰§è¡Œå¾—æ›´å¿«ï¼if contexpr
ä½†å½“å¤§é‡ä½¿ç”¨ template æˆ–å¼•ç”¨æ›´å¤šçš„ library ä¹Ÿè®© compiler çš„å·¥ä½œè¶Šæ¥è¶Šå¤šï¼Œè€Œå¦‚æœæ¯æ”¹å‡ è¡Œå°±è¦ç­‰å¾…ç¼–è¯‘å‡ åˆ†é’Ÿæ‰èƒ½çŸ¥é“æ‰§è¡Œç»“æœçš„è¯ï¼Œå¯¹äºä¸€å¤©è¦ç¼–è¯‘æ•°ç™¾æ¬¡çš„å¼€å‘è€…è€Œè¨€å®åœ¨æ˜¯å¤ªæµªè´¹ç”Ÿå‘½äº†ã€‚
æœ¬ç¯‡æ–‡ç« å°±è¦æ¥æ¢è®¨å„ç§åŠ é€Ÿ C++ Compile Time çš„æ–¹å¼ï¼Œå¤§éƒ¨åˆ†çš„æ–¹æ³•éƒ½æ˜¯ Stack Overflow æœåˆ®æ¥ï¼Œç„¶åç”±æˆ‘è‡ªè¡Œå®æµ‹ã€‚ æµ‹è¯•ç¯å¢ƒå¦‚ä¸‹ï¼š
- Ubuntu 18.04 LTS
- GCC 9
- CMake 3.23
- Ninja 1.8
- Project LOC ~20k


# Use ccache
å¼•å…¥ ccache ç»å¯¹æ˜¯æ•ˆç›Šæœ€é«˜çš„åŠ é€Ÿæ–¹å¼ï¼Œå®Œå…¨ä¸ç”¨æ”¹ç¨‹åºå°±å¯ä»¥å‡å°‘å¤§é‡çš„ç¼–è¯‘æ—¶é—´ã€‚ ccache æ˜¯ä¸€ä¸ªå…¨å±€çš„ compiler cacheï¼Œè—‰ç”±å¿«å–ç¼–è¯‘çš„ä¸­ç»§æ¡£æ¥èŠ‚çœé‡æ–°ç¼–è¯‘çš„æ—¶é—´ã€‚ å®‰è£…å¥½ä»¥ååªè¦åœ¨ ä¸­åŠ å…¥ï¼šCMakeLists.txt

```cmake
# CMakeLists.txt
SET_PROPERTY(GLOBAL PROPERTY RULE_LAUNCH_COMPILE ccache)
```
å³å¯ä½¿ç”¨ï¼Œå¦‚æœé¡¹ç›®æ²¡ä½¿ç”¨ build tools çš„è¯ï¼Œåˆ™æ˜¯ç›´æ¥åœ¨æŒ‡ä»¤å‰åŠ ä¸Š`ccache`, `gcc  ccache`

```bash
# before
$ /usr/bin/gcc main.cpp
# after
$ ccache /usr/bin/gcc main.cpp
```
ä½¿ç”¨ ccache ä¹‹åæ•´ä½“ç¼–è¯‘é€Ÿåº¦å¤§çº¦å¯ä»¥æå‡ä¸¤å€ä»¥ä¸Šï¼Œååˆ†èµï¼

# Use forward declaration as more as possible
C++ çš„ å…³é”®è¯å…¶å®å°±æ˜¯å¤åˆ¶ç²˜è´´ï¼Œæ‰€ä»¥å½“ä½ åœ¨ A.h include äº† B.hï¼Œåœ¨é¢„å¤„ç†é˜¶æ®µç¼–è¯‘å™¨ä¼šæŠŠ B.h å†…å®¹å¤åˆ¶åˆ° A.hï¼Œè€Œå¦‚æœä¸å¹¸çš„ B.h åˆ include ä¸€å †æ¡£æ¡ˆï¼Œé‚£ä¹Ÿä¼šé€šé€šå±•å¼€ã€‚ æ‰€ä»¥å¦‚æœå¼•ç”¨å¤ªå¤šæ¡£æ¡ˆï¼Œé™¤äº†ä¼šé€ æˆé¢„å¤„ç†ä¹‹åæ¡£æ¡ˆè‚¥å¤§ä»¥å¤–ï¼Œä¹Ÿä¼šé€ æˆæ¡£æ¡ˆä¹‹é—´ç›¸ä¾æ€§æ··ä¹±ï¼Œé—´æ¥å¯¼è‡´æ¯æ¬¡ç¼–è¯‘è¦é‡æ–°ç¼–è¯‘ä¸å¿…è¦çš„æ¡£æ¡ˆã€‚#include

é™¤äº†å°†æ²¡ç”¨çš„ include æ¸…å¹²å‡€ä»¥å¤–ï¼Œè¿˜å¯ä»¥æ›´æ¿€è¿›çš„é¿å…åœ¨ header include ä¸œè¥¿ï¼Œé‚£å°±æ˜¯åˆ©ç”¨ forward declarationã€‚
![image-20221227221151475](./img/Optimizing%20C++%20Compile%20Time/image-20221227221151475.png)

è¯•æƒ³ä»¥ä¸Šæƒ…å¢ƒï¼Œå½“ä½ å˜æ›´ A.h æ—¶ï¼ŒA B C éƒ½å¿…é¡»é‡æ–°ç¼–è¯‘ï¼Œå› ä¸ºå†…å®¹æ”¹å˜äº†ï¼Œä½†å®é™…ä¸Š C å¹¶æœªä½¿ç”¨åˆ° Aï¼Œå…¶å®åº”è¯¥å¯ä»¥é¿å…é‡æ–°ç¼–è¯‘ Cã€‚

ç”±äºCä¼šé‡æ–°ç¼–è¯‘æ˜¯å› ä¸º B.h å†…å®¹æ”¹å˜äº†ï¼Œè€Œ B.h å†…å®¹æ”¹å˜çš„åŸå› åˆ™æ˜¯å› ä¸º A.h æ›´æ–°äº†ã€‚ è¿™æ—¶å€™å¯ä»¥æŸ¥çœ‹ä¸ºç”šä¹ˆ B.h éœ€è¦å¼•ç”¨ A.hï¼Œçœ‹çœ‹æ˜¯å¦å¯ä»¥é¿å…å¼•ç”¨ã€‚

```c
/// B.h
#include "A.h"

class B {
 // ...skip
 private:
  const A& a;
};
```
ä»¥ä¸Šæ˜¯å¸¸è§çš„ä½¿ç”¨æƒ…å¢ƒï¼ŒB å­˜äº†ä¸€ä¸ª class A çš„å‚è€ƒã€‚`A& a`

æˆ‘ä»¬å¯ä»¥æ”¹å†™æˆè¿™æ ·ï¼Œå°† include ç§»åŠ¨åˆ° B.cpp å®ä½œæ–‡ä»¶ä¸­ã€‚ è¿™æ˜¯å› ä¸ºï¼Œ ç­‰è¿™ç±»ä¸œè¥¿çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥åœ¨å®šä¹‰æ—¶ä¸éœ€è¦çŸ¥é“å®é™… class A çš„å¤§å°ï¼Œåªéœ€å…ˆå‘ŠçŸ¥ compiler æœ‰è¿™ä¸ª class å³å¯ã€‚`A& ` `A*`

```c++
/// B.h
class A; //< forward declare !
class B {
 // ...skip
 private:
  const A& a;
};

/// B.cpp
#include "A.h"
```
å¦‚æ­¤ä¸€æ¥ï¼Œå½“ä½ å˜æ›´ A.h æ—¶ï¼ŒB.h å†…å®¹å¹¶ä¸ä¼šæ”¹å˜ï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘ C éœ€è¦é‡æ–°ç¼–è¯‘æ‹‰ï¼Œå¯å–œå¯è´º~

åœ¨å¤§é‡ä½¿ç”¨è¿™ä¸ªæŠ€å·§ä»¥åï¼Œæˆ‘æ‰€æµ‹è¯•çš„é¡¹ç›®è¿›æ­¥å¹…åº¦ä¹Ÿæ˜¯éå¸¸æ˜æ˜¾ï¼Œæ›´åŠ¨A.håŸæœ¬ä¼šç‰µåŠ¨54ä¸ªæ¡£æ¡ˆéœ€è¦é‡ç¼–è¯‘ï¼Œæ”¹å®Œä»¥ååˆ™åªä¼šç‰µåŠ¨29ä¸ªæ¡£æ¡ˆï¼Œè‡ªç„¶ç¼–è¯‘é€Ÿåº¦ä¹Ÿå°±å˜å¿«äº†ã€‚


```shell
# before use fwd v.s. after use fwd
# -j 6 incremental build, w/o ccache, unit in second
[touch A.h]
before = 303 (trigger 54 files rebuild)
after  = 178 (trigger 29 files rebuild)
```

# Unity Build
Unity build åˆç§° Jumbo buildï¼Œ Mega buildï¼Œå…¶åŸç†æ˜¯é€è¿‡å°†æ±‡æ•´æˆä¸€ä¸ªå†ä¸€èµ·æ‰§è¡Œç¼–è¯‘ï¼Œè¿™æ ·å°±æ˜¯çœä¸‹ N ä¸ªæ¡£æ¡ˆçš„ç¼–è¯‘æ—¶é—´ ï¼ˆå…·ä½“è€Œè¨€æ˜¯çœä¸‹å¦‚ template å±•å¼€ç­‰åŸæœ¬æ¯ä¸ª Translate Unit éƒ½è¦åšçš„äº‹æƒ…ï¼‰ã€‚`*.cppall.cpp`

CMake v3.16 å¼€å§‹å°±æ”¯æŒ Unity Build çš„è®¾å®šï¼Œä»–æ”¯æŒå°† batch size ä¸ªæ–‡ä»¶å…ˆæ±‡æ€»æˆä¹‹åå†è¿›è¡Œç¼–è¯‘ã€‚all_x.cpp

ä¸è¿‡è¿™æ–¹æ³•ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼Œç”±äºè¿™æ–¹æ³•ä¹‹åŸç†è¯´ç™½äº†å°±æ˜¯å¦‚æ­¤æš´åŠ›ï¼Œå¦‚æœé¡¹ç›®æœ¬èº«å¸¸å¸¸ä½¿ç”¨å…¨å±€å˜é‡çš„è¯ï¼Œè¿™ä¼šå¾ˆå®¹æ˜“å¯¼è‡´ODR ï¼ˆOne definition ruleï¼‰ é”™è¯¯ã€‚ æ‰€ä»¥ä¹Ÿæœ‰å¯èƒ½ä¸å®¹æ˜“å¼•å…¥ Unity Buildã€‚`cat *.cpp > all.cpp`

è¿™ä¸ªæŠ€å·§æˆ‘è®¤ä¸ºä¹Ÿæ˜¯ CP å€¼ååˆ†ä¹‹é«˜çš„æ–¹æ³•ï¼Œå‡ ä¹ä¸ç”¨æ”¹ç¨‹åº ï¼ˆå¦‚æœé¡¹ç›®ç”¨å¤ªå¤šå…¨å±€å˜é‡å°±è¦æ”¹å¾ˆå¤šğŸ˜…ï¼‰ å´å¯ä»¥è·å¾—å¤§å¹…çš„è¿›æ­¥ã€‚ æˆ‘æµ‹è¯•çš„ç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æ— è®ºæ˜¯ incremental build è¿˜æ˜¯ clean build éƒ½å–å¾— 50% ä»¥ä¸Šçš„è¿›æ­¥ã€‚

```c
# w/o unity build v.s. with unity build (batch_size=8)
# using -j 6, w/o ccache, unit in seconds
[touch A.h]
before = 242 # 38 tasks
after  = 167 # 18 tasks

[clean build]
before = 420 # 111 tasks
after  = 224 #  47 tasks
```

# Better linker
ç¼–è¯‘çš„æœ€åé˜¶æ®µæ˜¯ linkingï¼Œè¿™éƒ¨åˆ†å¯ä»¥æ›¿æ¢æˆæ¯”è¾ƒå‰å®³çš„ linkerï¼Œå¸‚é¢ä¸Šç›®å‰æœ‰ä¸‰ç§è¾ƒæœ‰åçš„ linker
- ld (gcc default)
- gold
- lld
- 
è¦æ›¿æ¢ä½¿ç”¨ linker åªéœ€è¦åœ¨ compile flag åŠ ä¸Šå³å¯ã€‚ è¯¦ç»†å¯å‚è€ƒ gcc documentã€‚ è€Œæˆ‘å®æµ‹ä¸åŒ linker è¡¨ç°å¦‚ä¸‹ï¼Œfuse-ld=<linker_name>
```ba
# rebuild using single thread, unit in second
# [1/1] Linking CXX executable main
[linker]
ld   = 25.4
gold = 11.6
lld  =  5.8
```
ä½¿ç”¨æ›´å¼ºçš„ linker è™½ç„¶ä½¿ linking time è¿›æ­¥è®¸å¤šï¼Œä½†å¯¹æ•´ä¸ªé¡¹ç›®çš„ compile time è€Œè¨€å…¶å®å æ¯”ä¸æ˜¯å¾ˆå¤§ï¼Œç›¸è¾ƒäºå‰é¢å‡ ä¸ªç« èŠ‚ç®—æ˜¯è¿›æ­¥è¾ƒå°çš„æŠ€å·§ã€‚ ï¼ˆä½† CP å€¼ä¹Ÿæ˜¯å¾ˆé«˜ï¼Œåªè¦æ”¹ä¸€ä¸ª compile flagï¼‰

# Disable var-tracking for huge variable object
æˆ‘ä»¬å¯ä»¥é€šè¿‡ gcc flag æ¥å‰–æç¼–è¯‘å„ä¸ªé˜¶æ®µçš„è€—æ—¶ï¼Œç„¶åé’ˆå¯¹å„ä¸ªè€—æ—¶å¤§çš„æ”¹å–„ã€‚`-ftime-report`

æˆ‘æµ‹è¯•çš„é¡¹ç›®ä¸­ï¼Œæœ‰ä¸€ä¸ª auto-generate çš„ï¼Œè¯¥æ¡£æ¡ˆåŠ¨è¾„æ•°ä¸‡è¡Œï¼Œæ¯æ¬¡ç¼–è¯‘è¯¥æ¡£æ¡ˆéƒ½ä¼šæˆä¸ºç“¶é¢ˆã€‚ ä»å¾—çŸ¥ç¼–è¯‘è¯¥æ¡£æ¡ˆè€—æ—¶æœ€å¤§çš„éƒ¨åˆ†æ˜¯ var-trackingï¼Œvar-tracking æ˜¯è®© debug info æœ‰æ›´å¤šä¿¡æ¯çš„åŠŸèƒ½ï¼Œä½†å½“é¡¹ç›®ä¸­æœ‰å·¨å¤§çš„å˜é‡æ—¶ï¼Œè¿™ä¼šè®© compiling é€Ÿåº¦å¤§å¹…å˜æ…¢ã€‚`unordered_map-ftime-report`

åœ¨å¯¹æˆ‘é‚£ä¸ªæ•°ä¸‡è¡Œçš„æ¡£æ¡ˆæ‹¿æ‰ var-tracking ä¹‹å ï¼ˆé’ˆå¯¹è¯¥æ–‡ä»¶åŠ ä¸Šä¸€ä¸ªflagï¼‰ ç»“æœå¦‚ä¸‹ï¼Œ`unordered_map` `-ftime-report`


```bash
# gcc -ftime-report auto_gen.cpp
# with var-tracking v.s. without var-tracking, sorted by usr time
[before]
Time variable                                   usr           sys          wall               GGC
 phase opt and generate             : 122.95 ( 92%)   2.30 ( 35%) 125.26 ( 89%)  924305 kB ( 46%)
 var-tracking dataflow              :  71.39 ( 53%)   0.15 (  2%)  71.57 ( 51%)    3714 kB (  0%)
 expand vars                        :  17.55 ( 13%)   0.03 (  0%)  17.56 ( 12%)    8583 kB (  0%)
 phase parsing                      :   8.09 (  6%)   3.46 ( 53%)  11.55 (  8%)  794986 kB ( 40%)
 alias stmt walking                 :   6.11 (  5%)   0.08 (  1%)   6.40 (  5%)     678 kB (  0%)
 template instantiation             :   4.35 (  3%)   1.58 ( 24%)   6.03 (  4%)  443040 kB ( 22%)
 phase lang. deferred               :   2.30 (  2%)   0.72 ( 11%)   3.02 (  2%)  232700 kB ( 12%)
 var-tracking emit                  :   2.87 (  2%)   0.02 (  0%)   2.95 (  2%)   20420 kB (  1%)
 |overload resolution               :   3.18 (  2%)   1.26 ( 19%)   4.50 (  3%)  330116 kB ( 16%)
 TOTAL                              : 134.16          6.54        140.82        2005866 kB

[after]
Time variable                                   usr           sys          wall               GGC
 phase opt and generate             :  44.61 ( 80%)   1.41 ( 27%)  46.03 ( 76%)  724840 kB ( 41%)
 expand vars                        :  18.45 ( 33%)   0.02 (  0%)  18.46 ( 30%)    8567 kB (  0%)
 phase parsing                      :   8.32 ( 15%)   3.12 ( 59%)  11.45 ( 19%)  794986 kB ( 45%)
 alias stmt walking                 :   6.39 ( 12%)   0.11 (  2%)   6.52 ( 11%)     678 kB (  0%)
 template instantiation             :   4.38 (  8%)   1.44 ( 27%)   5.93 ( 10%)  443040 kB ( 25%)
 |overload resolution               :   3.27 (  6%)   0.97 ( 18%)   4.51 (  7%)  330116 kB ( 19%)
 phase lang. deferred               :   2.27 (  4%)   0.70 ( 13%)   2.97 (  5%)  232700 kB ( 13%)
 parser (global)                    :   1.89 (  3%)   0.90 ( 17%)   3.05 (  5%)  211250 kB ( 12%)
 tree SSA incremental               :   1.58 (  3%)   0.01 (  0%)   1.55 (  3%)     259 kB (  0%)
 TOTAL                              :  55.49          5.27         60.81        1761326 kB

```
ç»“æœæ˜¯ä»åŸæœ¬è€—æ—¶134ç§’é™ä½è‡³è€—æ—¶55ç§’ï¼Œå‡å°‘è¶…è¿‡50%çš„æ—¶é—´ã€‚ è¿™ä¹Ÿä½¿å¾—è¯¥æ¡£æ¡ˆä¸ä¼šå†æ˜¯æ•´ä¸ªé¡¹ç›®çš„ç“¶é¢ˆã€‚

# Summary
æœ¬æ–‡å°è¯•äº†è®¸å¤šæŠ€å·§æ¥åŠ é€Ÿç¼–è¯‘æ‰€éœ€çš„æ—¶é—´ï¼Œæ€»ç»“å„ç‚¹å¦‚ä¸‹åˆ—ï¼š

- Use [big improvement] `ccache`
- Use forward declaration as more as possible [big improvement]
- Unity Build [big improvement]
- Use LLVM linker [good improvement]
- Disable var-tracking for huge variable object [good improvement]
- Pre-compiled headers [no improvement]
- Explicit template instantiation [no improvement]
åœ¨çˆ¬æ–‡æ—¶ç½‘å‹æåŠ pre-compiled headers ä»¥åŠ explicit ï¼ˆexternï¼‰ template ä¹Ÿå¯¹å‡å°‘ç¼–è¯‘æ—¶é—´æœ‰å¸®åŠ©ï¼Œä½†å®æµ‹å¹¶æœªæœ‰æ˜¾è‘—å·®å¼‚ï¼Œæ•…æœ¬æ–‡æœªæåŠï¼Œä¹Ÿè®¸å®é™…ä¸Šæ˜¯æœ‰ç”¨åªæ˜¯åˆšå¥½ä¸é€‚ç”¨äºæˆ‘çš„ç¯å¢ƒä¹‹ç±»çš„ã€‚

# Reference
- Improving Compilation Time of C/C++ Projects
- â€œvariable trackingâ€ is eating my compile time!
- CMake Unity Build

